---
# Playbook to deploy media server Nomad jobs and their update scripts
- name: Deploy Media Server Jobs
  hosts: nomad_servers[0]
  become: true

  vars:
    jobs_dir: "{{ playbook_dir }}/../../jobs"

  tasks:
    # Check for GPU device on Nomad clients if GPU transcoding is enabled
    - name: Warn about GPU transcoding requirement
      ansible.builtin.debug:
        msg: "WARNING: plex_gpu_transcoding is enabled. Ensure /dev/dri exists on your Nomad client nodes."
      when: (media_server == "plex" or media_server == "both") and plex_gpu_transcoding | default(true) | bool

    # Create temp directory for generated job files
    - name: Create temporary directory for job files
      ansible.builtin.tempfile:
        state: directory
        suffix: nomad-jobs
      register: temp_dir
      when: media_server == "plex" or media_server == "both"

    # Generate Plex job from template
    - name: Generate Plex job file
      ansible.builtin.template:
        src: ../templates/plex.nomad.j2
        dest: "{{ temp_dir.path }}/plex.nomad"
        mode: "0644"
      when: media_server == "plex" or media_server == "both"

    # Deploy Plex jobs
    - name: Deploy Plex service job
      ansible.builtin.command:
        cmd: nomad job run {{ temp_dir.path }}/plex.nomad
      register: plex_job
      changed_when: "'Job registration successful' in plex_job.stdout"
      when: media_server == "plex" or media_server == "both"

    - name: Deploy Plex update job
      ansible.builtin.command:
        cmd: nomad job run {{ jobs_dir }}/periodic/update-plex.nomad
      register: plex_update_job
      changed_when: "'Job registration successful' in plex_update_job.stdout"
      when: (media_server == "plex" or media_server == "both") and enable_updates | default(true) | bool

    - name: Deploy Plex backup job
      ansible.builtin.command:
        cmd: nomad job run {{ jobs_dir }}/periodic/backup-plex.nomad
      register: plex_backup_job
      changed_when: "'Job registration successful' in plex_backup_job.stdout"
      when: (media_server == "plex" or media_server == "both") and enable_backups | default(true) | bool

    # Deploy Jellyfin jobs
    - name: Deploy Jellyfin service job
      ansible.builtin.command:
        cmd: nomad job run {{ jobs_dir }}/services/jellyfin.nomad
      register: jellyfin_job
      changed_when: "'Job registration successful' in jellyfin_job.stdout"
      when: media_server == "jellyfin" or media_server == "both"

    - name: Deploy Jellyfin update job
      ansible.builtin.command:
        cmd: nomad job run {{ jobs_dir }}/periodic/update-jellyfin.nomad
      register: jellyfin_update_job
      changed_when: "'Job registration successful' in jellyfin_update_job.stdout"
      when: (media_server == "jellyfin" or media_server == "both") and enable_updates | default(true) | bool

    - name: Deploy Jellyfin backup job
      ansible.builtin.command:
        cmd: nomad job run {{ jobs_dir }}/periodic/backup-jellyfin.nomad
      register: jellyfin_backup_job
      changed_when: "'Job registration successful' in jellyfin_backup_job.stdout"
      when: (media_server == "jellyfin" or media_server == "both") and enable_backups | default(true) | bool

    # Clean up temporary directory
    - name: Clean up temporary directory
      ansible.builtin.file:
        path: "{{ temp_dir.path }}"
        state: absent
      when: temp_dir.path is defined

    # Display results
    - name: Show deployed jobs
      ansible.builtin.debug:
        msg: |
          Deployed jobs for media_server={{ media_server }}:
          {% if media_server == "plex" or media_server == "both" %}
          - plex (service{% if plex_gpu_transcoding | default(true) | bool %}, GPU enabled{% endif %})
          {% if enable_updates | default(true) | bool %}
          - update-plex (periodic)
          {% endif %}
          {% if enable_backups | default(true) | bool %}
          - backup-plex (periodic)
          {% endif %}
          {% endif %}
          {% if media_server == "jellyfin" or media_server == "both" %}
          - jellyfin (service)
          {% if enable_updates | default(true) | bool %}
          - update-jellyfin (periodic)
          {% endif %}
          {% if enable_backups | default(true) | bool %}
          - backup-jellyfin (periodic)
          {% endif %}
          {% endif %}
