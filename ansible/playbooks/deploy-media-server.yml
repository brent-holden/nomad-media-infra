---
# Deploy media server using Nomad Pack
#
# This playbook runs on the controller (macOS) and deploys either Plex or Jellyfin
# to the remote Nomad cluster.
#
# Usage:
#   Deploy Plex (default):    ansible-playbook -i inventory.ini playbooks/deploy-media-server.yml
#   Deploy Jellyfin:          ansible-playbook -i inventory.ini playbooks/deploy-media-server.yml -e media_server=jellyfin
#   Without GPU transcoding:  ansible-playbook -i inventory.ini playbooks/deploy-media-server.yml -e media_server_gpu_transcoding=false
#   Restore from backup:      ansible-playbook -i inventory.ini playbooks/deploy-media-server.yml -e restore_from_backup=true
#   Restore specific date:    ansible-playbook -i inventory.ini playbooks/deploy-media-server.yml -e restore_from_backup=true -e backup_date=2025-01-15

- name: Deploy Media Server
  hosts: controller
  gather_facts: true
  vars:
    # Restore from backup (default: false)
    restore_from_backup: false
  tasks:
    - name: Validate media_server value
      ansible.builtin.assert:
        that:
          - media_server in ['plex', 'jellyfin']
        fail_msg: "media_server must be 'plex' or 'jellyfin'. Got: {{ media_server }}"
        success_msg: "Deploying media server: {{ media_server }}"

    # Check and install Nomad Pack via Homebrew
    - name: Check if Nomad Pack is installed
      ansible.builtin.command:
        cmd: nomad-pack version
      register: nomad_pack_check
      changed_when: false
      failed_when: false

    - name: Install Nomad Pack if not present
      when: nomad_pack_check.rc != 0
      block:
        - name: Tap HashiCorp repository
          community.general.homebrew_tap:
            name: hashicorp/tap
            state: present

        - name: Install Nomad Pack via Homebrew
          community.general.homebrew:
            name: hashicorp/tap/nomad-pack
            state: latest

        - name: Verify Nomad Pack installation
          ansible.builtin.command:
            cmd: nomad-pack version
          register: nomad_pack_verify
          changed_when: false

        - name: Display Nomad Pack version
          ansible.builtin.debug:
            msg: "Installed Nomad Pack: {{ nomad_pack_verify.stdout }}"

    # Deploy media server to remote Nomad cluster
    - name: Check if Nomad Pack registry exists
      ansible.builtin.command:
        cmd: nomad-pack registry list
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      register: registry_list
      changed_when: false
      failed_when: false

    - name: Add Nomad Pack registry
      ansible.builtin.command:
        cmd: nomad-pack registry add {{ nomad_pack_registry_name }} {{ nomad_pack_registry_url }}
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      when: nomad_pack_registry_name not in registry_list.stdout
      register: registry_add
      changed_when: "'added' in registry_add.stdout"

    # Create CSI volumes for network storage
    - name: Create temporary directory for volume configs
      ansible.builtin.tempfile:
        state: directory
        suffix: nomad-volumes
      register: temp_dir

    - name: Generate media-drive volume configuration
      ansible.builtin.template:
        src: ../templates/media-drive-volume.hcl.j2
        dest: "{{ temp_dir.path }}/media-drive-volume.hcl"
        mode: "0600"

    - name: Generate backup-drive volume configuration
      ansible.builtin.template:
        src: ../templates/backup-drive-volume.hcl.j2
        dest: "{{ temp_dir.path }}/backup-drive-volume.hcl"
        mode: "0600"
      when: media_server_enable_backup | default(true) | bool

    - name: Register media-drive CSI volume
      ansible.builtin.command:
        cmd: nomad volume register {{ temp_dir.path }}/media-drive-volume.hcl
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      register: media_volume
      changed_when: "'registered' in media_volume.stdout"
      failed_when: media_volume.rc != 0 and 'exists' not in media_volume.stderr

    - name: Register backup-drive CSI volume
      ansible.builtin.command:
        cmd: nomad volume register {{ temp_dir.path }}/backup-drive-volume.hcl
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      register: backup_volume
      changed_when: "'registered' in backup_volume.stdout"
      failed_when: backup_volume.rc != 0 and 'exists' not in backup_volume.stderr
      when: media_server_enable_backup | default(true) | bool

    - name: Clean up temporary directory
      ansible.builtin.file:
        path: "{{ temp_dir.path }}"
        state: absent

    # Create dynamic host volumes (mkdir plugin creates directories automatically)
    - name: Create Plex config volume
      ansible.builtin.shell: |
        nomad volume create - <<'EOF'
        name      = "plex-config"
        type      = "host"
        plugin_id = "mkdir"
        capability {
          access_mode     = "single-node-multi-writer"
          attachment_mode = "file-system"
        }
        parameters {
          mode = "0755"
          uid  = "{{ user_uid }}"
          gid  = "{{ group_gid }}"
        }
        EOF
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      register: plex_config_vol
      changed_when: "'Created' in plex_config_vol.stdout"
      failed_when: false
      when: media_server == "plex" or media_server == "both"

    - name: Create Jellyfin config volume
      ansible.builtin.shell: |
        nomad volume create - <<'EOF'
        name      = "jellyfin-config"
        type      = "host"
        plugin_id = "mkdir"
        capability {
          access_mode     = "single-node-multi-writer"
          attachment_mode = "file-system"
        }
        parameters {
          mode = "0755"
          uid  = "{{ user_uid }}"
          gid  = "{{ group_gid }}"
        }
        EOF
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      register: jellyfin_config_vol
      changed_when: "'Created' in jellyfin_config_vol.stdout"
      failed_when: false
      when: media_server == "jellyfin" or media_server == "both"

    #
    # RESTORE FROM BACKUP WORKFLOW
    # If restore_from_backup=true, we:
    #   1. Deploy with enable_restore=true (creates restore job)
    #   2. Dispatch the restore job
    #   3. Wait for completion
    #   4. Redeploy with enable_restore=false (removes restore job, starts service)
    #
    - name: Restore from backup workflow
      when: restore_from_backup | bool
      block:
        - name: Display restore workflow start
          ansible.builtin.debug:
            msg: "Starting restore workflow for {{ media_server }}..."

        - name: Deploy restore job only
          ansible.builtin.command:
            cmd: >-
              nomad-pack run --registry={{ nomad_pack_registry_name }}
              -var gpu_transcoding={{ media_server_gpu_transcoding | lower }}
              -var enable_backup=false
              -var enable_update=false
              -var enable_restore=true
              {{ media_server }}
          environment:
            NOMAD_ADDR: "{{ nomad_addr }}"
          register: restore_deploy
          changed_when: "'deployed' in restore_deploy.stdout or 'Plan' in restore_deploy.stdout"

        - name: Wait for restore job to be registered
          ansible.builtin.pause:
            seconds: 5

        - name: Build dispatch command
          ansible.builtin.set_fact:
            dispatch_cmd: >-
              nomad job dispatch
              {{ '-meta backup_date=' + backup_date if backup_date is defined else '' }}
              {{ media_server }}-restore

        - name: Dispatch restore job
          ansible.builtin.command:
            cmd: "{{ dispatch_cmd }}"
          environment:
            NOMAD_ADDR: "{{ nomad_addr }}"
          register: dispatch_result
          changed_when: true

        - name: Extract dispatch job ID
          ansible.builtin.set_fact:
            dispatch_job_id: "{{ dispatch_result.stdout | regex_search('Dispatched Job ID = (.+)', '\\1') | first }}"

        - name: Display restore job info
          ansible.builtin.debug:
            msg: "Restore job dispatched: {{ dispatch_job_id }}"

        - name: Wait for restore job to complete
          ansible.builtin.command:
            cmd: nomad job status {{ dispatch_job_id }}
          environment:
            NOMAD_ADDR: "{{ nomad_addr }}"
          register: job_status
          until: "'dead' in job_status.stdout or 'complete' in job_status.stdout"
          retries: 60
          delay: 5
          changed_when: false

        - name: Get restore job logs
          ansible.builtin.command:
            cmd: nomad alloc logs -job {{ dispatch_job_id }}
          environment:
            NOMAD_ADDR: "{{ nomad_addr }}"
          register: restore_logs
          changed_when: false

        - name: Display restore logs
          ansible.builtin.debug:
            var: restore_logs.stdout_lines

        - name: Check if restore succeeded
          ansible.builtin.fail:
            msg: "Restore job failed. Check logs above."
          when: "'Restore complete!' not in restore_logs.stdout"

        - name: Display restore success
          ansible.builtin.debug:
            msg: "Restore completed successfully. Now deploying {{ media_server }} service..."

    #
    # NORMAL DEPLOYMENT
    # Deploy the service (with or without restore job removed)
    #
    - name: Build nomad-pack variables for deployment
      ansible.builtin.set_fact:
        pack_vars: >-
          -var gpu_transcoding={{ media_server_gpu_transcoding | lower }}
          -var enable_backup={{ media_server_enable_backup | lower }}
          -var enable_update={{ media_server_enable_update | lower }}
          -var enable_restore=false

    - name: Deploy {{ media_server }} with Nomad Pack
      ansible.builtin.command:
        cmd: nomad-pack run --registry={{ nomad_pack_registry_name }} {{ pack_vars }} {{ media_server }}
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      register: pack_result
      changed_when: "'deployed' in pack_result.stdout or 'Plan' in pack_result.stdout"

    - name: Display deployment result
      ansible.builtin.debug:
        var: pack_result.stdout_lines

    - name: Verify job is running
      ansible.builtin.command:
        cmd: nomad job status {{ media_server }}
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      register: job_status
      until: "'running' in job_status.stdout"
      retries: 30
      delay: 5
      changed_when: false

    - name: Display job status
      ansible.builtin.debug:
        msg: |
          {{ media_server }} is now running!
          {% if restore_from_backup | bool %}
          Configuration was restored from backup{{ ' (' + backup_date + ')' if backup_date is defined else ' (latest)' }}.
          {% endif %}
          Access at http://192.168.0.10:{{ '32400' if media_server == 'plex' else '8096' }}
