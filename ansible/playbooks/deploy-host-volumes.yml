---
# Playbook to deploy dynamic host volumes for media server storage
- name: Deploy Dynamic Host Volumes
  hosts: controller
  gather_facts: false

  tasks:
    - name: Get target hostname from Nomad node
      ansible.builtin.command:
        cmd: nomad node status -json
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      register: nomad_nodes
      changed_when: false

    - name: Set target hostname fact
      ansible.builtin.set_fact:
        target_hostname: "{{ (nomad_nodes.stdout | from_json)[0].Name }}"

    - name: Create temporary directory for volume configs
      ansible.builtin.tempfile:
        state: directory
        suffix: nomad-host-volumes
      register: temp_dir

    # Plex volumes
    - name: Generate Plex config volume configuration
      ansible.builtin.template:
        src: ../templates/plex-config-volume.hcl.j2
        dest: "{{ temp_dir.path }}/plex-config-volume.hcl"
        mode: "0600"
      when: media_server == "plex" or media_server == "both"

    - name: Generate Plex transcode volume configuration
      ansible.builtin.template:
        src: ../templates/plex-transcode-volume.hcl.j2
        dest: "{{ temp_dir.path }}/plex-transcode-volume.hcl"
        mode: "0600"
      when: media_server == "plex" or media_server == "both"

    - name: Create Plex config volume
      ansible.builtin.command:
        cmd: nomad volume create {{ temp_dir.path }}/plex-config-volume.hcl
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      register: plex_config_volume
      changed_when: "'Created' in plex_config_volume.stdout"
      failed_when: plex_config_volume.rc != 0 and 'exists' not in plex_config_volume.stderr
      when: media_server == "plex" or media_server == "both"

    - name: Create Plex transcode volume
      ansible.builtin.command:
        cmd: nomad volume create {{ temp_dir.path }}/plex-transcode-volume.hcl
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      register: plex_transcode_volume
      changed_when: "'Created' in plex_transcode_volume.stdout"
      failed_when: plex_transcode_volume.rc != 0 and 'exists' not in plex_transcode_volume.stderr
      when: media_server == "plex" or media_server == "both"

    # Jellyfin volumes
    - name: Generate Jellyfin config volume configuration
      ansible.builtin.template:
        src: ../templates/jellyfin-config-volume.hcl.j2
        dest: "{{ temp_dir.path }}/jellyfin-config-volume.hcl"
        mode: "0600"
      when: media_server == "jellyfin" or media_server == "both"

    - name: Generate Jellyfin cache volume configuration
      ansible.builtin.template:
        src: ../templates/jellyfin-cache-volume.hcl.j2
        dest: "{{ temp_dir.path }}/jellyfin-cache-volume.hcl"
        mode: "0600"
      when: media_server == "jellyfin" or media_server == "both"

    - name: Create Jellyfin config volume
      ansible.builtin.command:
        cmd: nomad volume create {{ temp_dir.path }}/jellyfin-config-volume.hcl
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      register: jellyfin_config_volume
      changed_when: "'Created' in jellyfin_config_volume.stdout"
      failed_when: jellyfin_config_volume.rc != 0 and 'exists' not in jellyfin_config_volume.stderr
      when: media_server == "jellyfin" or media_server == "both"

    - name: Create Jellyfin cache volume
      ansible.builtin.command:
        cmd: nomad volume create {{ temp_dir.path }}/jellyfin-cache-volume.hcl
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      register: jellyfin_cache_volume
      changed_when: "'Created' in jellyfin_cache_volume.stdout"
      failed_when: jellyfin_cache_volume.rc != 0 and 'exists' not in jellyfin_cache_volume.stderr
      when: media_server == "jellyfin" or media_server == "both"

    - name: Clean up temporary directory
      ansible.builtin.file:
        path: "{{ temp_dir.path }}"
        state: absent

    - name: Show created volumes
      ansible.builtin.debug:
        msg: |
          Created dynamic host volumes on {{ target_hostname }}:
          {% if media_server == "plex" or media_server == "both" %}
          - plex-config ({{ plex_config_dir }})
          - plex-transcode ({{ plex_transcode_dir }})
          {% endif %}
          {% if media_server == "jellyfin" or media_server == "both" %}
          - jellyfin-config ({{ jellyfin_config_dir }})
          - jellyfin-cache ({{ jellyfin_cache_dir }})
          {% endif %}
