---
# Restore media server configuration from backup
#
# This playbook stops the media server, restores from backup, and restarts it.
#
# Usage:
#   Restore from latest backup:  ansible-playbook -i inventory.ini playbooks/restore-media-server.yml
#   Restore specific date:       ansible-playbook -i inventory.ini playbooks/restore-media-server.yml -e backup_date=2025-01-15

- name: Restore Media Server
  hosts: controller
  gather_facts: true
  tasks:
    - name: Validate media_server value
      ansible.builtin.assert:
        that:
          - media_server in ['plex', 'jellyfin']
        fail_msg: "media_server must be 'plex' or 'jellyfin'. Got: {{ media_server }}"
        success_msg: "Restoring media server: {{ media_server }}"

    - name: Check if restore job exists
      ansible.builtin.command:
        cmd: nomad job status restore-{{ media_server }}
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      register: restore_job_check
      changed_when: false
      failed_when: false

    - name: Fail if restore job not deployed
      ansible.builtin.fail:
        msg: |
          The restore-{{ media_server }} job is not deployed.
          Deploy with enable_restore=true first:
            ansible-playbook -i inventory.ini playbooks/deploy-media-server.yml -e media_server_enable_restore=true
      when: restore_job_check.rc != 0

    - name: Check if {{ media_server }} is running
      ansible.builtin.command:
        cmd: nomad job status {{ media_server }}
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      register: media_server_status
      changed_when: false
      failed_when: false

    - name: Stop {{ media_server }} service
      ansible.builtin.command:
        cmd: nomad job stop {{ media_server }}
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      register: stop_result
      changed_when: "'complete' in stop_result.stdout"
      failed_when: false
      when: media_server_status.rc == 0 and 'running' in media_server_status.stdout

    - name: Wait for {{ media_server }} to stop
      ansible.builtin.pause:
        seconds: 10
      when: media_server_status.rc == 0 and 'running' in media_server_status.stdout

    - name: Build dispatch command
      ansible.builtin.set_fact:
        dispatch_cmd: >-
          nomad job dispatch
          {{ '-meta backup_date=' + backup_date if backup_date is defined else '' }}
          restore-{{ media_server }}

    - name: Dispatch restore job
      ansible.builtin.command:
        cmd: "{{ dispatch_cmd }}"
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      register: dispatch_result
      changed_when: true

    - name: Extract dispatch job ID
      ansible.builtin.set_fact:
        dispatch_job_id: "{{ dispatch_result.stdout | regex_search('Dispatched Job ID = (.+)', '\\1') | first }}"

    - name: Display restore job info
      ansible.builtin.debug:
        msg: "Restore job dispatched: {{ dispatch_job_id }}"

    - name: Wait for restore job to complete
      ansible.builtin.command:
        cmd: nomad job status {{ dispatch_job_id }}
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      register: job_status
      until: "'dead' in job_status.stdout or 'complete' in job_status.stdout"
      retries: 60
      delay: 5
      changed_when: false

    - name: Get restore job logs
      ansible.builtin.command:
        cmd: nomad alloc logs -job {{ dispatch_job_id }}
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      register: restore_logs
      changed_when: false

    - name: Display restore logs
      ansible.builtin.debug:
        var: restore_logs.stdout_lines

    - name: Check if restore succeeded
      ansible.builtin.fail:
        msg: "Restore job failed. Check logs above."
      when: "'Restore complete!' not in restore_logs.stdout"

    - name: Build nomad-pack variables
      ansible.builtin.set_fact:
        pack_vars: >-
          -var gpu_transcoding={{ media_server_gpu_transcoding | lower }}
          -var enable_backup={{ media_server_enable_backup | lower }}
          -var enable_update={{ media_server_enable_update | lower }}
          -var enable_restore={{ media_server_enable_restore | lower }}

    - name: Restart {{ media_server }} with Nomad Pack
      ansible.builtin.command:
        cmd: nomad-pack run --registry={{ nomad_pack_registry_name }} {{ pack_vars }} {{ media_server }}
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      register: pack_result
      changed_when: "'deployed' in pack_result.stdout or 'registered' in pack_result.stdout"

    - name: Verify job is running
      ansible.builtin.command:
        cmd: nomad job status {{ media_server }}
      environment:
        NOMAD_ADDR: "{{ nomad_addr }}"
      register: job_status
      until: "'running' in job_status.stdout"
      retries: 30
      delay: 5
      changed_when: false

    - name: Display success message
      ansible.builtin.debug:
        msg: |
          Restore complete!
          {{ media_server }} is now running with restored configuration.
          Access at http://192.168.0.10:{{ '32400' if media_server == 'plex' else '8096' }}
